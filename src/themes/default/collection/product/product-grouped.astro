---
import SectionTitle from "../../section-title.astro";

const { records } = Astro.props;

// Group products by their associated record groups for categorized rendering.
const groupedRecords = (records || []).reduce(
  (acc, record) => {
    const recordGroups =
      Array.isArray(record?.groups) && record.groups.length > 0
        ? record.groups
        : [{ title: "Other", slug: "other" }];

    recordGroups.forEach((group) => {
      const key = group?.slug || group?.title || "other";
      if (!acc[key]) {
        acc[key] = { group, items: [] };
      }
      acc[key].items.push(record);
    });

    return acc;
  },
  {} as Record<string, { group: any; items: any[] }>
);

const groupedEntries = Object.values(groupedRecords) as {
  group: any;
  items: any[];
}[];
---

<!-- {JSON.stringify(records, null, 2)} -->
<section class="relative w-full max-w-7xl mx-auto lg:pb-24">
  <SectionTitle {...Astro.props} />

  <div class="py-4 px-2 lg:px-0 space-y-10">
    {
      groupedEntries.length === 0 ? (
        <p>No products available.</p>
      ) : (
        groupedEntries.map(({ group, items }) => {
          const heading = group?.title || "Other";
          const subTitle = group?.subTitle || group?.subtitle;
          const excerpt = group?.excerpt;

          return (
            <div class="space-y-3">
              {groupedEntries.length > 1 && (
                <div class="space-y-2 pt-16">
                  <h2 class="text-2xl font-semibold capitalize">{heading}</h2>
                  {(subTitle || excerpt) && (
                    <p class="text-sm text-gray-600">{subTitle || excerpt}</p>
                  )}
                </div>
              )}

              <ol
                class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3"
                role="list"
              >
                {items.map((record) => {
                  const basePath =
                    record?.contentType ||
                    record?.labels?.plural?.toLowerCase() ||
                    "products";
                  const isOutOfStock = Boolean(record?.outOfStock);
                  const priceLabel =
                    typeof record?.price === "number"
                      ? `â‚¹ ${record.price}`
                      : null;

                  return (
                    <li class="list-none">
                      <a
                        href={`/${basePath}/${record?.slug}`}
                        title={record?.title}
                        aria-label={record?.title}
                        class="no-underline block border-0 border-gray-200 rounded-md py-3 hover:border-gray-300 transition"
                      >
                        <div class="flex items-start justify-between gap-2">
                          <div class="flex items-center gap-2">
                            <span
                              class={`font-semibold ${
                                isOutOfStock
                                  ? "text-gray-400 line-through"
                                  : "text-gray-900"
                              }`}
                            >
                              {record?.title}
                            </span>
                            {isOutOfStock && (
                              <span class="text-xs font-medium bg-gray-200 text-gray-700 px-2 py-0.5 rounded">
                                Not Available
                              </span>
                            )}
                          </div>
                          {priceLabel && (
                            <span
                              class={`text-sm font-medium ${
                                isOutOfStock
                                  ? "text-gray-400 line-through"
                                  : "text-gray-900"
                              }`}
                            >
                              {priceLabel}
                            </span>
                          )}
                        </div>

                        {record?.excerpt && (
                          <p
                            class={`text-sm mt-1 line-clamp-2 ${
                              isOutOfStock
                                ? "text-gray-400 line-through"
                                : "text-gray-600"
                            }`}
                          >
                            {record.excerpt}
                          </p>
                        )}
                      </a>
                    </li>
                  );
                })}
              </ol>
            </div>
          );
        })
      )
    }
  </div>
</section>
