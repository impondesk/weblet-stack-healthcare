---
import readingTime from "reading-time";
import { defaultTheme } from "../../consts";
import { fetchDynamicCollection } from "../../api/collection";
import { getCategoryByDomain } from "../../api/category";
import CategoryLayout from "../../layouts/category-layout.astro";
import CategoryFallback from "./category-fallback.astro";

let { collectionType, slug } = Astro.params;

// Use optional chaining and fallback to empty string if host is undefined
// @ts-ignore: Assume host is present in locals at runtime
const host = (Astro.locals as { host?: string })?.host || "";

/* The line `console.log("getCategoryByDomain response:", response);` is logging the response
received from the API call made in the `getCategoryByDomain` function. This is a helpful debugging
statement that outputs the response data to the console, allowing developers to inspect the data
returned by the API and verify that the function is working as expected. */
const data = await getCategoryByDomain(host, slug);

let instanceData = await data?.docs[0];
if (!instanceData) {
  throw new Error(`Category not found for slug: ${slug}`);
}

const { content = undefined } = instanceData;

// if (!content) {
//   throw new Error(`Content not found for category with slug: ${slug}`);
// }

// const minutesRead = 0;
// const minutesRead = readingTime(JSON.stringify(content || ""));
// console.log(minutesRead);

const tag = instanceData;

if (tag?.tenant) {
  (Astro.locals as { tenant?: any; theme?: any }).tenant = tag.tenant;
  (Astro.locals as { tenant?: any; theme?: any }).theme = tag.tenant.theme;
}

// Tenant Dynamic Collections

let dynamicCollectionData = [];

// If layout is blank or not defined, show default text
let fallbagImpl = false;
if (!tag.layout || (Array.isArray(tag.layout) && tag.layout.length === 0)) {
  fallbagImpl = true;
}

const dynamicCollections = Array.isArray(tag.layout)
  ? tag.layout.filter((e: any) => e.blockType === "collection")
  : [];
// console.log(dynamicCollections);

if (dynamicCollections.length > 0) {
  dynamicCollectionData = await fetchDynamicCollection(
    "categories",
    tag?.id,
    tag?.tenant?.id
  );
} else {
  dynamicCollectionData = [];
}

const instance = {
  ...data.docs[0],
  collectionType,
  slug,
  className: "category-page",
  title: data.docs[0].title || "category",
  excerpt: data.docs[0].excerpt || "",
  authors: data.docs[0].authors || [],
  updatedAt: data.docs[0].updatedAt || new Date().toISOString(),
  categories: data.docs[0].categories || [],
  category: data.docs[0].category || "", //FIXME check if needed
  featured: data.docs[0].featured || false,
  theme: data.docs[0].tenant.theme || defaultTheme,
  video: data.docs[0].video || null,
  audioLink: data.docs[0].audioLink || null,
  // minutesRead: minutesRead,
  records: dynamicCollectionData,
};

console.log(instance);

// const author = authors && authors[0];
// const product = products && products[0];
---

{
  fallbagImpl ? (
    <CategoryFallback {...instance} />
  ) : (
    <CategoryLayout {...instance} />
  )
}
