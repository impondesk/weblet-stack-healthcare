---
import readingTime from "reading-time";
import { defaultTheme } from "../../consts";
import { getArticleByDomain } from "../../api/article";
// Update the import path if the file is located elsewhere, for example:
import ArticleLayout from "../../layouts/article-layout.astro";
// Or ensure that '../../layouts/ArticleLayout.astro' exists and is correctly named

let { collectionType, slug } = Astro.params;

// Use optional chaining and fallback to empty string if host is undefined
// @ts-ignore: Assume host is present in locals at runtime
const host = (Astro.locals as { host?: string })?.host || "";
const data = await getArticleByDomain(host, slug);

let instanceData = await data?.docs[0];
if (!instanceData) {
  throw new Error(`Article not found for slug: ${slug}`);
}

const { content = undefined } = instanceData;

// if (!content) {
//   throw new Error(`Content not found for post with slug: ${slug}`);
// }

const minutesRead = readingTime(JSON.stringify(content || ""));
// console.log(minutesRead);

const instance = {
  ...data?.docs[0],
  collectionType,
  slug,
  className: "post-page",
  title: data?.docs[0]?.title || "post",
  excerpt: data?.docs[0]?.excerpt || "",

  authors: data?.docs[0]?.authors || [],
  author: (data?.docs[0]?.authors && data?.docs[0]?.authors[0]) || undefined,

  updatedAt: data?.docs[0]?.updatedAt || new Date().toISOString(),
  groups: data?.docs[0]?.groups || [],
  group: (data?.docs[0]?.groups && data?.docs[0]?.groups[0]) || undefined,
  tags: data?.docs[0]?.tags || [],
  category: data?.docs[0]?.category || "",
  featured: data?.docs[0]?.featured || false,
  theme: data?.docs[0]?.tenant.theme || defaultTheme,
  video: data?.docs[0]?.video || null,
  audioLink: data?.docs[0]?.audioLink || null,
  minutesRead: minutesRead,
  pubDatetime:
    data?.docs[0]?.createdAt ||
    data?.docs[0]?.updatedAt ||
    new Date().toISOString(),
};

// console.log(instance);

const post = instanceData;

if (post?.tenant) {
  (Astro.locals as { tenant?: any; theme?: any }).tenant = post.tenant;
  (Astro.locals as { tenant?: any; theme?: any }).theme = post.tenant.theme;

  // Tenant Dynamic Collections
  // FIXME
}

// const author = authors && authors[0];
// const product = products && products[0];
---

<ArticleLayout {...instance} />
